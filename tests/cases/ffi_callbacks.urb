fail = 0;

load_fixture = (path){
  return ffi.load(path,
    "i32 call_cb_i32(void*, i32, i32)",
    "i32 fold_cb_i32(void*, i32, i32)",
    "f64 call_cb_f64(void*, f64, f64)"
  );
};

lib = load_fixture("./tests/ffi/libffi_view_struct.so");
if (lib == null) { lib = load_fixture("./tests/ffi/libffi_view_struct.dylib"); }
if (lib == null) { lib = load_fixture("./tests/ffi/libffi_view_struct.dll"); }
if (lib == null) {
  println(1);
  return 0;
}

cb_add = ffi.callback("i32 cb(i32, i32)", (a, b){ return a + b; });
if (lib.call_cb_i32(cb_add, 9, 4) != 13) { fail++; }

cb_mul_add = ffi.callback("i32 fold(i32, i32)", (acc, x){ return acc + (x * 2); });
if (lib.fold_cb_i32(cb_mul_add, 1, 4) != 21) { fail++; }

cb_f = ffi.callback("f64 cbf(f64, f64)", (a, b){ return a + b + 0.25; });
if (lib.call_cb_f64(cb_f, 1.5, 2.5) != 4.25) { fail++; }

println(fail);
