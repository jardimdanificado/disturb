fail = 0;

half = {
  lo = "int16",
  hi = "int16"
};

bits = {
  __meta = { union = 1 },
  i = "int32",
  f = "float",
  p = "struct<half>"
};

holder = {
  tag = "int32",
  payload = "union<bits>"
};

holder_ptr = {
  tag = "int32",
  payload = "union<bits>",
  ref = "pointer<bits>"
};

load_fixture = (path){
  return ffi.load(path,
    "i32 bits_sizeof()",
    "i32 bits_off_i()",
    "i32 bits_off_f()",
    "i32 bits_off_p()",
    "i32 bits_take_value_i(union<bits>)",
    "union<bits> make_bits_value_i(i32)",
    "void bits_write_i(pointer<bits>, i32)",
    "i32 bits_read_hi(union<bits>)",
    "i32 holder_sizeof()",
    "i32 holder_off_tag()",
    "i32 holder_off_payload()",
    "i32 holder_take_payload_i(struct<holder>)"
  );
};

lib = load_fixture("./tests/ffi/libffi_view_struct.so");
if (lib == null) { lib = load_fixture("./tests/ffi/libffi_view_struct.dylib"); }
if (lib == null) { lib = load_fixture("./tests/ffi/libffi_view_struct.dll"); }
if (lib == null) {
  println(1);
  return 0;
}

if (ffi.sizeof(bits) != lib.bits_sizeof()) { fail++; }
if (ffi.offsetof(bits, "i") != lib.bits_off_i()) { fail++; }
if (ffi.offsetof(bits, "f") != lib.bits_off_f()) { fail++; }
if (ffi.offsetof(bits, "p") != lib.bits_off_p()) { fail++; }

if (ffi.sizeof(holder) != lib.holder_sizeof()) { fail++; }
if (ffi.offsetof(holder, "tag") != lib.holder_off_tag()) { fail++; }
if (ffi.offsetof(holder, "payload") != lib.holder_off_payload()) { fail++; }

bp = ffi.new(bits);
bv = ffi.view(bp, bits);

bv.i = 42;
if (lib.bits_take_value_i(bv) != 42) { fail++; }

lib.bits_write_i(bp, 0x11223344);
if (bv.i != 0x11223344) { fail++; }

bv.p.hi = 123;
if (lib.bits_read_hi(bv) != 123) { fail++; }

ret = lib.make_bits_value_i(99);
if (ret.i != 99) { fail++; }

hp = ffi.new(holder);
hv = ffi.view(hp, holder);

hv.tag = 7;
hv.payload.i = 77;
if (lib.holder_take_payload_i(hv) != 77) { fail++; }

hp2 = ffi.new(holder_ptr);
hv2 = ffi.view(hp2, holder_ptr);
hv2.ref = bp;
if (hv2.ref.i != bv.i) { fail++; }

hv2.ref.i = -12;
if (bv.i != -12) { fail++; }

ffi.free(hp);
ffi.free(hp2);
ffi.free(bp);

println(fail);
