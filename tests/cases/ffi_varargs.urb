fail = 0;

load_fixture = (path){
  return ffi.load(path,
    "i32 sum_variadic_i32(i32, ...)",
    "f64 sum_variadic_f64(i32, ...)",
    "void* get_sum_variadic_i32_ptr()"
  );
};

lib = load_fixture("./tests/ffi/libffi_view_struct.so");
if (lib == null) { lib = load_fixture("./tests/ffi/libffi_view_struct.dylib"); }
if (lib == null) { lib = load_fixture("./tests/ffi/libffi_view_struct.dll"); }
if (lib == null) {
  println(1);
  return 0;
}

if (lib.sum_variadic_i32(5, 1, 2, 3, 4, 5) != 15) { fail++; }
if (lib.sum_variadic_i32(0) != 0) { fail++; }

f = lib.sum_variadic_f64(4, 1.5, 2.5, 3.0, 4.0);
if (f != 11.0) { fail++; }

ptr = lib.get_sum_variadic_i32_ptr();
sum = ffi.bind(ptr, "const i32 sum(const i32, ...)");
if (sum(4, 10, 20, 30, 40) != 100) { fail++; }

println(fail);
