fail = 0;

schema = {
  a = "int32",
  b = "float64",
  d = {
    a = "int8",
    b = "int16"
  }
};
outer = schema;

load_fixture = (path){
  return ffi.load(path,
    "void* make_outer()",
    "void free_outer(void*)",
    "i32 outer_sizeof()",
    "i32 outer_off_a()",
    "i32 outer_off_b()",
    "i32 outer_off_d()",
    "i32 inner_off_a()",
    "i32 inner_off_b()",
    "i32 outer_get_a(void*)",
    "f64 outer_get_b(void*)",
    "i32 inner_get_a(void*)",
    "i32 inner_get_b(void*)",
    "void* make_arr_outer()",
    "void free_arr_outer(void*)",
    "i32 arr_outer_sizeof()",
    "i32 arr_outer_off_head()",
    "i32 arr_outer_off_vals()",
    "i32 arr_outer_off_f32s()",
    "i32 arr_outer_get_val(void*, i32)",
    "f32 arr_outer_get_f32(void*, i32)",
    "void* get_add_i32_ptr()",
    "i32 sum_outer_value(@outer)",
    "@outer make_outer_value(i32, f64, i8, i16)"
  );
};

lib = load_fixture("./tests/ffi/libffi_view_struct.so");
if (lib == null) { lib = load_fixture("./tests/ffi/libffi_view_struct.dylib"); }
if (lib == null) { lib = load_fixture("./tests/ffi/libffi_view_struct.dll"); }
if (lib == null) {
  println(1);
  return 0;
}

layout = ffi.compile(schema);

if (ffi.sizeof(layout) != lib.outer_sizeof()) { fail++; }
if (ffi.offsetof(layout, "a") != lib.outer_off_a()) { fail++; }
if (ffi.offsetof(layout, "b") != lib.outer_off_b()) { fail++; }
if (ffi.offsetof(layout, "d") != lib.outer_off_d()) { fail++; }
if (ffi.offsetof(layout, "d.a") != lib.outer_off_d() + lib.inner_off_a()) { fail++; }
if (ffi.offsetof(layout, "d.b") != lib.outer_off_d() + lib.inner_off_b()) { fail++; }

arr_schema = {
  head = "int32",
  vals = "int64[8]",
  f32s = "float[3]"
};

if (ffi.sizeof(arr_schema) != lib.arr_outer_sizeof()) { fail++; }
if (ffi.offsetof(arr_schema, "head") != lib.arr_outer_off_head()) { fail++; }
if (ffi.offsetof(arr_schema, "vals") != lib.arr_outer_off_vals()) { fail++; }
if (ffi.offsetof(arr_schema, "f32s") != lib.arr_outer_off_f32s()) { fail++; }

if (ffi.sizeof({ p = "int32[]" }) != ffi.sizeof({ p = "ptr" })) { fail++; }

ptr = lib.make_outer();
v = ffi.view(ptr, layout);

if (v.a != 0) { fail++; }
if (v.d.a != 0) { fail++; }
if (v.d.b != 0) { fail++; }

v.a = 45;
v.b = 10.5;
v.d.b = 45;
v.d.a = 128;

if (lib.outer_get_a(ptr) != 45) { fail++; }
if (lib.inner_get_b(ptr) != 45) { fail++; }
if (lib.inner_get_a(ptr) != -128) { fail++; }

if (v.a != 45) { fail++; }
if (v.d.b != 45) { fail++; }
if (v.d.a != -128) { fail++; }

lib.free_outer(ptr);

arr_ptr = lib.make_arr_outer();
arr_v = ffi.view(arr_ptr, arr_schema);
arr_v.vals[2] = 77;
arr_v.f32s[1] = 1.5;
if (lib.arr_outer_get_val(arr_ptr, 2) != 77) { fail++; }
if (lib.arr_outer_get_f32(arr_ptr, 1) != 1.5) { fail++; }
lib.free_arr_outer(arr_ptr);

add_ptr = lib.get_add_i32_ptr();
add = ffi.bind(add_ptr, "i32 add(i32, i32)");
if (add(20, 22) != 42) { fail++; }

ptr2 = lib.make_outer();
v2 = ffi.view(ptr2, layout);
v2.a = 10;
v2.d.a = 2;
v2.d.b = 3;
if (lib.sum_outer_value(v2) != 15) { fail++; }
lib.free_outer(ptr2);

ret = lib.make_outer_value(7, 1.5, 2, 9);
if (ret.a != 7) { fail++; }
if (ret.d.a != 2) { fail++; }
if (ret.d.b != 9) { fail++; }
if (ret.b != 1.5) { fail++; }

println(fail);
