name: Release Manual

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version (ex: 1.2.0)"
        required: true
        type: string
      create_tag:
        description: "Create tag vX.Y.Z if it does not exist"
        required: true
        default: true
        type: boolean
      prerelease:
        description: "Mark release as pre-release"
        required: true
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.name }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Linux
            os: ubuntu-latest
            target: linux
          - name: macOS
            os: macos-latest
            target: macos
          - name: Windows (MSYS2/MinGW64)
            os: windows-latest
            target: windows-mingw
          - name: Windows (MSVC)
            os: windows-latest
            target: windows-msvc
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate version format
        shell: bash
        run: |
          if ! [[ "${{ inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+([.-][0-9A-Za-z.-]+)?$ ]]; then
            echo "Invalid version format: ${{ inputs.version }}"
            exit 1
          fi

      - name: Install dependencies (Ubuntu)
        if: matrix.target == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libffi-dev

      - name: Install dependencies (macOS)
        if: matrix.target == 'macos'
        run: |
          brew update
          brew install libffi

      - name: Setup MSYS2 (Windows MinGW)
        if: matrix.target == 'windows-mingw'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            git
            make
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-libffi

      - name: Build binary (Linux/macOS)
        if: matrix.target == 'linux' || matrix.target == 'macos'
        shell: bash
        run: |
          if [ "${RUNNER_OS}" = "macOS" ]; then
            export CPATH="$(brew --prefix libffi)/include"
            export LIBRARY_PATH="$(brew --prefix libffi)/lib"
          fi
          make clean
          make -j"$(getconf _NPROCESSORS_ONLN || echo 2)"

      - name: Build binary (Windows MinGW)
        if: matrix.target == 'windows-mingw'
        shell: msys2 {0}
        run: |
          make clean
          make -j2

      - name: Build binary (Windows MSVC)
        if: matrix.target == 'windows-msvc'
        shell: powershell
        run: |
          cmake -S . -B build-msvc -A x64 -DENABLE_FFI_CALLS=OFF
          cmake --build build-msvc --config Release -j2

      - name: Package artifact (Linux)
        if: matrix.target == 'linux'
        shell: bash
        run: |
          mkdir -p dist
          cp disturb dist/
          cp README.md CHANGELOG.md dist/
          tar -czf "dist/disturb-v${{ inputs.version }}-linux-x64.tar.gz" -C dist disturb README.md CHANGELOG.md

      - name: Package artifact (macOS)
        if: matrix.target == 'macos'
        shell: bash
        run: |
          mkdir -p dist
          cp disturb dist/
          cp README.md CHANGELOG.md dist/
          tar -czf "dist/disturb-v${{ inputs.version }}-macos-x64.tar.gz" -C dist disturb README.md CHANGELOG.md

      - name: Package artifact (Windows MinGW)
        if: matrix.target == 'windows-mingw'
        shell: msys2 {0}
        run: |
          mkdir -p dist
          cp disturb.exe dist/
          cp README.md CHANGELOG.md dist/
          powershell -NoProfile -Command "Compress-Archive -Path dist\\disturb.exe,dist\\README.md,dist\\CHANGELOG.md -DestinationPath dist\\disturb-v${{ inputs.version }}-windows-x64-mingw.zip -Force"

      - name: Package artifact (Windows MSVC)
        if: matrix.target == 'windows-msvc'
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          Copy-Item build-msvc/Release/disturb.exe dist/
          Copy-Item README.md,CHANGELOG.md dist/
          Compress-Archive -Path dist/disturb.exe,dist/README.md,dist/CHANGELOG.md -DestinationPath dist/disturb-v${{ inputs.version }}-windows-x64-msvc.zip -Force

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: disturb-${{ matrix.target }}
          path: dist/*
          if-no-files-found: error

  release:
    name: Publish release
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create tag if requested
        if: inputs.create_tag
        run: |
          tag="v${{ inputs.version }}"
          if git rev-parse "$tag" >/dev/null 2>&1; then
            echo "Tag $tag already exists"
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$tag" -m "Release $tag"
          git push origin "$tag"

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Extract changelog notes
        id: notes
        run: |
          version="${{ inputs.version }}"
          notes="$(awk -v v="$version" '
            $0 ~ "^## " v "$" { in=1; next }
            in && $0 ~ "^## " { exit }
            in { print }
          ' CHANGELOG.md)"
          if [ -z "$notes" ]; then
            notes="Release v$version"
          fi
          {
            echo "body<<EOF"
            echo "$notes"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.version }}
          name: v${{ inputs.version }}
          body: ${{ steps.notes.outputs.body }}
          prerelease: ${{ inputs.prerelease }}
          files: artifacts/**/*
